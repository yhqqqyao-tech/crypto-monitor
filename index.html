<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit vs Binance æœŸè´§ä»·æ ¼ç›‘æ§ - ç‹¬ç«‹ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(168, 85, 247, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            color: #000;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: none;
            font-weight: 700;
            letter-spacing: 1px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .symbol-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .symbol-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        
        .symbol-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
        }

        .symbol-tag button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 2px 8px;
            margin-left: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .symbol-tag button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group label {
            font-weight: 600;
            color: #000;
            margin-right: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a1a;
        }

        .input-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3), 0 0 20px rgba(99, 102, 241, 0.2);
            background: rgba(255, 255, 255, 1);
        }

        .input-group button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .input-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        }

        .price-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(99, 102, 241, 0.4);
        }

        .symbol-title {
            font-size: 0.95em;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
            text-align: center;
            text-transform: uppercase;
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 6px;
            margin-bottom: 6px;
        }

        .price-item {
            padding: 6px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(245, 247, 250, 0.9) 0%, rgba(195, 207, 226, 0.9) 100%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .price-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .price-item.bybit {
            background: linear-gradient(135deg, rgba(255, 236, 210, 0.9) 0%, rgba(252, 182, 159, 0.9) 100%);
            border: 1px solid rgba(252, 182, 159, 0.5);
        }

        .price-item.binance {
            background: linear-gradient(135deg, rgba(161, 196, 253, 0.9) 0%, rgba(194, 233, 251, 0.9) 100%);
            border: 1px solid rgba(161, 196, 253, 0.5);
        }

        .exchange-name {
            font-size: 0.7em;
            font-weight: 600;
            color: #000;
            margin-bottom: 2px;
        }

        .price-value {
            font-size: 1em;
            font-weight: 700;
            color: #000;
            margin-bottom: 1px;
        }

        .price-time {
            font-size: 0.6em;
            color: #000;
            line-height: 1.2;
        }

        .difference-section {
            padding: 6px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(255, 234, 167, 0.9) 0%, rgba(253, 203, 110, 0.9) 100%);
            border: 1px solid rgba(253, 203, 110, 0.5);
            text-align: center;
            margin-bottom: 6px;
            transition: all 0.3s ease;
        }

        .difference-section:hover {
            box-shadow: 0 4px 12px rgba(253, 203, 110, 0.4);
        }

        .funding-section {
            padding: 6px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(225, 190, 231, 0.9) 0%, rgba(206, 147, 216, 0.9) 100%);
            border: 1px solid rgba(206, 147, 216, 0.5);
            text-align: center;
            transition: all 0.3s ease;
        }

        .funding-section:hover {
            box-shadow: 0 4px 12px rgba(206, 147, 216, 0.4);
        }

        .funding-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 5px;
        }

        .funding-item {
            padding: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .funding-label {
            font-size: 0.6em;
            color: #000;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .funding-value {
            font-size: 0.8em;
            font-weight: 700;
            color: #000;
            line-height: 1.2;
        }

        .funding-value.positive {
            color: #000;
        }

        .funding-value.negative {
            color: #000;
        }

        .funding-diff {
            font-size: 0.55em;
            color: #000;
            margin-top: 1px;
            line-height: 1.2;
        }

        .spot-futures-section {
            padding: 6px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(178, 223, 219, 0.9) 0%, rgba(128, 203, 196, 0.9) 100%);
            border: 1px solid rgba(128, 203, 196, 0.5);
            text-align: center;
            margin-top: 6px;
            transition: all 0.3s ease;
        }
        
        .spot-futures-section:hover {
            box-shadow: 0 4px 12px rgba(128, 203, 196, 0.4);
        }

        .spot-futures-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 5px;
        }

        .spot-futures-item {
            padding: 5px;
            background: rgba(255,255,255,0.4);
            border-radius: 4px;
        }

        .spot-futures-label {
            font-size: 0.6em;
            color: #000;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .spot-futures-value {
            font-size: 0.75em;
            font-weight: 700;
            color: #000;
            line-height: 1.2;
        }

        .spot-futures-value.positive {
            color: #000;
        }

        .spot-futures-value.negative {
            color: #000;
        }

        .difference-label {
            font-size: 0.75em;
            font-weight: 600;
            color: #000;
            margin-bottom: 3px;
        }

        .difference-value {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .difference-value.positive {
            color: #000;
        }

        .difference-value.negative {
            color: #000;
        }

        .status {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: #000;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .alert-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .alert-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #000;
        }

        .alert-count {
            font-size: 1.5em;
            font-weight: 700;
            color: #000;
        }

        .alert-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
        }

        .alert-item.flash {
            animation: flashAlert 1s ease-in-out;
        }

        @keyframes flashAlert {
            0%, 100% { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); }
            50% { background: linear-gradient(135deg, #ffccbc 0%, #ffab91 100%); }
        }

        .alert-time {
            font-size: 0.85em;
            color: #000;
            margin-bottom: 5px;
        }

        .alert-detail {
            font-size: 1em;
            color: #000;
            font-weight: 600;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(500px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-title {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .notification-content {
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Bybit vs Binance æœŸè´§ä»·æ ¼ç›‘æ§</h1>
        
        <div class="input-section">
            <div class="input-group">
                <label for="symbolInput">æ·»åŠ äº¤æ˜“å¯¹:</label>
                <input type="text" id="symbolInput" placeholder="ä¾‹å¦‚: BTCUSDT">
                <button onclick="addSymbol()">â• æ·»åŠ </button>
                <label for="thresholdInput">å·®ä»·ç‡é˜ˆå€¼(%):</label>
                <input type="number" id="thresholdInput" placeholder="0.3" value="0.3" step="0.01" min="0.01" style="max-width: 120px;">
                <label for="priceChangeThresholdInput">ä»·æ ¼æ³¢åŠ¨é˜ˆå€¼(%):</label>
                <input type="number" id="priceChangeThresholdInput" placeholder="1.0" value="1.0" step="0.1" min="0.1" style="max-width: 120px;">
                <button onclick="startMonitoring()" id="startBtn">å¼€å§‹ç›‘æ§</button>
                <button onclick="stopMonitoring()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">åœæ­¢ç›‘æ§</button>
            </div>
            <div class="symbol-list" id="symbolList"></div>
        </div>

        <div class="status" id="status">è¯·æ·»åŠ äº¤æ˜“å¯¹å¹¶ç‚¹å‡»"å¼€å§‹ç›‘æ§"</div>
        
        <div class="alert-section" id="alertSection" style="display: none;">
            <div class="alert-header">
                <div class="alert-title">ğŸ”” å·®ä»·ç‡å˜åŠ¨æé†’</div>
                <div class="alert-count">æ€»å˜åŠ¨æ¬¡æ•°: <span id="alertCount">0</span></div>
            </div>
            
            <div class="alert-history" id="alertHistory"></div>
        </div>
        
        <div id="priceContainer"></div>
    </div>

    <script>
        let intervalId = null;
        let monitoringSymbols = [];
        let symbolData = {};
        let totalAlertCount = 0;
        let currentThreshold = 0.3;
        let priceChangeThreshold = 1.0; // ä»·æ ¼æ³¢åŠ¨é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰

        // ç›´æ¥è°ƒç”¨ Bybit API è·å–ä»·æ ¼å’Œèµ„é‡‘è´¹ç‡
        async function getBybitPrice(symbol) {
            try {
                // è·å–åˆçº¦ä¿¡æ¯ï¼ˆåŒ…å«èµ„é‡‘è´¹ç‡ç»“ç®—é—´éš”ï¼‰
                const instrumentResponse = await fetch(`https://api.bybit.com/v5/market/instruments-info?category=linear&symbol=${symbol}`);
                const instrumentData = await instrumentResponse.json();
                
                if (instrumentData.retCode !== 0 || instrumentData.result.list.length === 0) {
                    throw new Error('Bybit: æœªæ‰¾åˆ°è¯¥äº¤æ˜“å¯¹');
                }
                
                const instrument = instrumentData.result.list[0];
                
                // ä»åˆçº¦ä¿¡æ¯ä¸­è·å–èµ„é‡‘è´¹ç‡ç»“ç®—é—´éš”ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰
                let fundingInterval = 480; // é»˜è®¤480åˆ†é’Ÿ = 8å°æ—¶
                if (instrument.fundingInterval) {
                    fundingInterval = parseInt(instrument.fundingInterval);
                }
                const fundingIntervalHours = fundingInterval / 60; // è½¬æ¢ä¸ºå°æ—¶
                
                // è·å–å®æ—¶ä»·æ ¼å’Œèµ„é‡‘è´¹ç‡
                const tickerResponse = await fetch(`https://api.bybit.com/v5/market/tickers?category=linear&symbol=${symbol}`);
                const tickerData = await tickerResponse.json();
                
                if (tickerData.retCode !== 0 || tickerData.result.list.length === 0) {
                    throw new Error('Bybit: æœªæ‰¾åˆ°ä»·æ ¼æ•°æ®');
                }
                
                const ticker = tickerData.result.list[0];
                
                return {
                    price: parseFloat(ticker.lastPrice),
                    fundingRate: parseFloat(ticker.fundingRate || 0),
                    fundingInterval: fundingIntervalHours, // å°æ—¶
                    nextFundingTime: ticker.nextFundingTime,
                    timestamp: Date.now()
                };
            } catch (error) {
                throw new Error(`Bybit API é”™è¯¯: ${error.message}`);
            }
        }

        // è·å– Binance ç°è´§ä»·æ ¼
        async function getBinanceSpotPrice(symbol) {
            try {
                const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`);
                const data = await response.json();
                
                if (data.code) {
                    throw new Error('Binance Spot: æœªæ‰¾åˆ°è¯¥äº¤æ˜“å¯¹');
                }
                
                return {
                    price: parseFloat(data.price),
                    timestamp: Date.now()
                };
            } catch (error) {
                throw new Error(`Binance Spot API é”™è¯¯: ${error.message}`);
            }
        }

        // è·å– Binance æœŸè´§ä»·æ ¼ï¼ˆç®€åŒ–ç‰ˆï¼Œåªè·å–ä»·æ ¼ï¼‰
        async function getBinanceFuturesPrice(symbol) {
            try {
                const response = await fetch(`https://fapi.binance.com/fapi/v1/ticker/price?symbol=${symbol}`);
                const data = await response.json();
                
                if (data.code) {
                    throw new Error('Binance Futures: æœªæ‰¾åˆ°è¯¥äº¤æ˜“å¯¹');
                }
                
                return {
                    price: parseFloat(data.price),
                    timestamp: Date.now()
                };
            } catch (error) {
                throw new Error(`Binance Futures API é”™è¯¯: ${error.message}`);
            }
        }

        // è·å– Binance ç°è´§ä¸æœŸè´§å·®ä»·ç‡
        async function fetchSpotFuturesPrices(symbol) {
            try {
                const [spotData, futuresData] = await Promise.all([
                    getBinanceSpotPrice(symbol),
                    getBinanceFuturesPrice(symbol)
                ]);

                const priceDifference = futuresData.price - spotData.price;
                const differenceRate = (priceDifference / spotData.price) * 100;

                return {
                    symbol: symbol,
                    spot: spotData,
                    futures: futuresData,
                    priceDifference: priceDifference,
                    differenceRate: differenceRate
                };
            } catch (error) {
                throw error;
            }
        }

        // ç¼“å­˜ Binance äº¤æ˜“æ‰€ä¿¡æ¯ä»¥å‡å°‘ API è°ƒç”¨
        let binanceExchangeInfoCache = null;
        let binanceExchangeInfoCacheTime = 0;
        const CACHE_DURATION = 60000; // ç¼“å­˜1åˆ†é’Ÿ

        // è·å– Binance äº¤æ˜“æ‰€ä¿¡æ¯
        async function getBinanceExchangeInfo() {
            const now = Date.now();
            if (binanceExchangeInfoCache && (now - binanceExchangeInfoCacheTime) < CACHE_DURATION) {
                return binanceExchangeInfoCache;
            }
            
            const response = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
            const data = await response.json();
            binanceExchangeInfoCache = data;
            binanceExchangeInfoCacheTime = now;
            return data;
        }

        // ç›´æ¥è°ƒç”¨ Binance API è·å–ä»·æ ¼å’Œèµ„é‡‘è´¹ç‡
        async function getBinancePrice(symbol) {
            try {
                // è·å–äº¤æ˜“æ‰€ä¿¡æ¯ä»¥ç¡®å®šèµ„é‡‘è´¹ç‡ç»“ç®—é—´éš”
                const exchangeInfo = await getBinanceExchangeInfo();
                const symbolInfo = exchangeInfo.symbols?.find(s => s.symbol === symbol);
                
                if (!symbolInfo) {
                    throw new Error('Binance: æœªæ‰¾åˆ°è¯¥äº¤æ˜“å¯¹');
                }
                
                // ä»äº¤æ˜“æ‰€ä¿¡æ¯ä¸­è·å–èµ„é‡‘è´¹ç‡ç»“ç®—é—´éš”ï¼ˆå°æ—¶ï¼‰
                // Binance åœ¨ symbolInfo ä¸­æ²¡æœ‰ç›´æ¥çš„ fundingInterval å­—æ®µ
                // éœ€è¦é€šè¿‡å†å²èµ„é‡‘è´¹ç‡è®°å½•æ¥ç¡®å®šé—´éš”
                let fundingInterval = 8; // é»˜è®¤8å°æ—¶
                
                // è·å–æœ€è¿‘çš„èµ„é‡‘è´¹ç‡å†å²è®°å½•æ¥ç¡®å®šå®é™…é—´éš”
                try {
                    const fundingHistoryResponse = await fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=${symbol}&limit=5`);
                    const fundingHistory = await fundingHistoryResponse.json();
                    
                    console.log(`${symbol} Binance èµ„é‡‘è´¹å†å²:`, fundingHistory);
                    
                    if (Array.isArray(fundingHistory) && fundingHistory.length >= 2) {
                        // Binance API è¿”å›çš„æ•°æ®æ˜¯é™åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                        // éœ€è¦æŒ‰æ—¶é—´å‡åºæ’åˆ—åå†è®¡ç®—
                        const sortedHistory = [...fundingHistory].sort((a, b) => a.fundingTime - b.fundingTime);
                        
                        // è®¡ç®—ç›¸é‚»ä¸¤æ¬¡ç»“ç®—çš„æ—¶é—´é—´éš”
                        const intervals = [];
                        for (let i = 1; i < sortedHistory.length; i++) {
                            const intervalMs = sortedHistory[i].fundingTime - sortedHistory[i-1].fundingTime;
                            const intervalHours = intervalMs / (1000 * 60 * 60);
                            if (intervalHours > 0 && intervalHours <= 24) {
                                intervals.push(intervalHours);
                            }
                        }
                        
                        if (intervals.length > 0) {
                            // å–æœ€å¸¸è§çš„é—´éš”å€¼ï¼ˆé€šå¸¸æ‰€æœ‰é—´éš”éƒ½ç›¸åŒï¼‰
                            fundingInterval = intervals[0];
                            
                            console.log(`${symbol} è®¡ç®—çš„é—´éš”:`, intervals);
                            console.log(`æœ€æ—§ç»“ç®—æ—¶é—´: ${new Date(sortedHistory[0].fundingTime).toLocaleString()}`);
                            console.log(`æœ€æ–°ç»“ç®—æ—¶é—´: ${new Date(sortedHistory[sortedHistory.length-1].fundingTime).toLocaleString()}`);
                            console.log(`âœ… ${symbol} Binance èµ„é‡‘è´¹ç»“ç®—é—´éš”: ${fundingInterval}å°æ—¶`);
                        } else {
                            console.warn(`âš ï¸ ${symbol} æ— æ³•è®¡ç®—æœ‰æ•ˆé—´éš”ï¼Œä½¿ç”¨é»˜è®¤å€¼8å°æ—¶`);
                        }
                    } else {
                        console.warn(`âš ï¸ ${symbol} èµ„é‡‘è´¹å†å²æ•°æ®ä¸è¶³`);
                    }
                } catch (e) {
                    console.error(`âŒ è·å– ${symbol} èµ„é‡‘è´¹å†å²å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼8å°æ—¶`, e);
                }
                
                // è·å–ä»·æ ¼
                const priceResponse = await fetch(`https://fapi.binance.com/fapi/v1/ticker/price?symbol=${symbol}`);
                const priceData = await priceResponse.json();
                
                if (priceData.code) {
                    throw new Error('Binance: æœªæ‰¾åˆ°ä»·æ ¼æ•°æ®');
                }
                
                // è·å–å½“å‰èµ„é‡‘è´¹ç‡
                const fundingResponse = await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${symbol}`);
                const fundingData = await fundingResponse.json();
                
                if (fundingData.code) {
                    throw new Error('Binance: æœªæ‰¾åˆ°èµ„é‡‘è´¹ç‡æ•°æ®');
                }
                
                return {
                    price: parseFloat(priceData.price),
                    fundingRate: parseFloat(fundingData.lastFundingRate || 0),
                    fundingInterval: fundingInterval, // å°æ—¶
                    nextFundingTime: fundingData.nextFundingTime,
                    timestamp: Date.now()
                };
            } catch (error) {
                throw new Error(`Binance API é”™è¯¯: ${error.message}`);
            }
        }

        // å°†èµ„é‡‘è´¹ç‡æ¢ç®—æˆ8å°æ—¶è´¹ç‡
        // rate: å•æ¬¡ç»“ç®—çš„èµ„é‡‘è´¹ç‡
        // interval: ç»“ç®—é—´éš”ï¼ˆå°æ—¶ï¼‰
        // è¿”å›: 8å°æ—¶çš„èµ„é‡‘è´¹ç‡
        function convertTo8HourRate(rate, interval) {
            if (!interval || interval <= 0) {
                return rate; // å¦‚æœé—´éš”æ— æ•ˆï¼Œç›´æ¥è¿”å›åŸå€¼
            }
            
            // è®¡ç®—8å°æ—¶å†…ç»“ç®—çš„æ¬¡æ•°
            const settlementsIn8Hours = 8 / interval;
            
            // 8å°æ—¶æ€»è´¹ç‡ = å•æ¬¡è´¹ç‡ Ã— ç»“ç®—æ¬¡æ•°
            return rate * settlementsIn8Hours;
        }

        // è·å–æ‰€æœ‰æ•°æ®ï¼šBybitæœŸè´§ã€BinanceæœŸè´§ã€Binanceç°è´§
        async function fetchPrices(symbol) {
            try {
                const [bybitData, binanceData, binanceSpotData] = await Promise.all([
                    getBybitPrice(symbol),
                    getBinancePrice(symbol),
                    getBinanceSpotPrice(symbol).catch(() => null) // ç°è´§å¯èƒ½ä¸å­˜åœ¨
                ]);

                // Bybit vs Binance æœŸè´§å·®ä»·ç‡
                const futuresPriceDifference = bybitData.price - binanceData.price;
                const futuresDifferenceRate = (futuresPriceDifference / binanceData.price) * 100;

                // æ¢ç®—æˆ8å°æ—¶èµ„é‡‘è´¹ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
                const bybitFunding8h = convertTo8HourRate(bybitData.fundingRate, bybitData.fundingInterval) * 100;
                const binanceFunding8h = convertTo8HourRate(binanceData.fundingRate, binanceData.fundingInterval) * 100;
                const fundingDifference = bybitFunding8h - binanceFunding8h;

                // Binance ç°è´§ vs æœŸè´§å·®ä»·ç‡
                let spotFuturesDifferenceRate = null;
                let spotFuturesPriceDifference = null;
                if (binanceSpotData) {
                    spotFuturesPriceDifference = binanceData.price - binanceSpotData.price;
                    spotFuturesDifferenceRate = (spotFuturesPriceDifference / binanceSpotData.price) * 100;
                }

                return {
                    symbol: symbol,
                    bybit: bybitData,
                    binance: binanceData,
                    binanceSpot: binanceSpotData,
                    
                    // Bybit vs Binance æœŸè´§
                    futuresPriceDifference: futuresPriceDifference,
                    futuresDifferenceRate: futuresDifferenceRate,
                    
                    // èµ„é‡‘è´¹ç‡
                    bybitFunding8h: bybitFunding8h,
                    binanceFunding8h: binanceFunding8h,
                    fundingDifference: fundingDifference,
                    bybitInterval: bybitData.fundingInterval,
                    binanceInterval: binanceData.fundingInterval,
                    
                    // Binance ç°è´§ vs æœŸè´§
                    spotFuturesDifferenceRate: spotFuturesDifferenceRate,
                    spotFuturesPriceDifference: spotFuturesPriceDifference
                };
            } catch (error) {
                throw error;
            }
        }

        function addSymbol() {
            const input = document.getElementById('symbolInput');
            const symbol = input.value.trim().toUpperCase();
            
            if (!symbol) {
                alert('è¯·è¾“å…¥äº¤æ˜“å¯¹');
                return;
            }
            
            if (monitoringSymbols.includes(symbol)) {
                alert('è¯¥äº¤æ˜“å¯¹å·²æ·»åŠ ');
                return;
            }
            
            monitoringSymbols.push(symbol);
            symbolData[symbol] = {
                initialRate: null,
                baselineRate: null,
                alertCount: 0,
                // ä»·æ ¼æ³¢åŠ¨ç›‘æ§
                initialPrice: null,
                baselinePrice: null,
                priceAlertCount: 0
            };
            
            updateSymbolList();
            input.value = '';
        }

        function removeSymbol(symbol) {
            const index = monitoringSymbols.indexOf(symbol);
            if (index > -1) {
                monitoringSymbols.splice(index, 1);
                delete symbolData[symbol];
                updateSymbolList();
                
                if (intervalId) {
                    updateAllPrices();
                }
            }
        }

        function updateSymbolList() {
            const container = document.getElementById('symbolList');
            if (monitoringSymbols.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = monitoringSymbols.map(symbol => `
                <div class="symbol-tag">
                    ${symbol}
                    <button onclick="removeSymbol('${symbol}')">Ã—</button>
                </div>
            `).join('');
        }

        function formatPrice(price) {
            return parseFloat(price).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 8
            });
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN');
        }

        function showNotification(symbol, title, message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-title">${symbol} - ${title}</div>
                <div class="notification-content">${message}</div>
            `;
            document.body.appendChild(notification);
            
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OihUBELTKXh8bllHAU2jdXvzn0pBSh+zPDckTsHElyx6OyrWBUIQ5zd8sFuJAUuhM/z2Ik3CBhju+zooVARC0yl4fG5ZRwFNo3V7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBSh+zO/OfSkFKH7M7859KQUofszvzn0pBQ==');
                audio.play().catch(() => {});
            } catch (e) {}
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.5s ease-out reverse';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function addAlertToHistory(symbol, type, value, baseline, change) {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN');
            
            // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
            const historyContainer = document.getElementById('alertHistory');
            
            let detailHtml = '';
            if (type === 'å·®ä»·ç‡å˜åŠ¨') {
                detailHtml = `
                    å·®ä»·ç‡: ${value >= 0 ? '+' : ''}${value.toFixed(4)}% | 
                    åŸºå‡†: ${baseline.toFixed(4)}% | 
                    å˜åŠ¨: ${change >= 0 ? '+' : ''}${change.toFixed(4)}%
                `;
            } else if (type === 'ä»·æ ¼æ³£åŠ¨') {
                detailHtml = `
                    ä»·æ ¼æ³¢åŠ¨: ${value >= 0 ? '+' : ''}${value.toFixed(2)}% | 
                    å½“å‰ä»·æ ¼: $${baseline.toFixed(4)} | 
                    å˜åŠ¨: $${change >= 0 ? '+' : ''}${change.toFixed(4)}
                `;
            }
            
            const itemHtml = `
                <div class="alert-item flash">
                    <div class="alert-time">â° ${timeStr} - <strong>${symbol}</strong> [${type}]</div>
                    <div class="alert-detail">${detailHtml}</div>
                </div>
            `;
            
            historyContainer.insertAdjacentHTML('afterbegin', itemHtml);
        }

        function checkDifferenceRateChange(symbol, currentDiffRate) {
            const currentAbsRate = Math.abs(currentDiffRate);
            const data = symbolData[symbol];
            
            if (!data) return;
            
            if (data.initialRate === null) {
                data.initialRate = currentAbsRate;
                data.baselineRate = currentAbsRate;
                document.getElementById('alertSection').style.display = 'block';
                return;
            }
            
            const change = currentAbsRate - data.baselineRate;
            const changeAbs = Math.abs(change);
            
            if (changeAbs >= currentThreshold) {
                data.alertCount++;
                totalAlertCount++;
                document.getElementById('alertCount').textContent = totalAlertCount;
                
                data.baselineRate = currentAbsRate;
                
                const message = `å·®ä»·ç‡å˜åŠ¨è¾¾åˆ° ${changeAbs.toFixed(4)}%\nå½“å‰å·®ä»·ç‡: ${currentDiffRate.toFixed(4)}%\næ–°åŸºå‡†: ${currentAbsRate.toFixed(4)}%`;
                showNotification(symbol, 'ğŸš¨ å·®ä»·ç‡å¤§å¹…å˜åŠ¨ï¼', message);
                
                addAlertToHistory(symbol, `å·®ä»·ç‡å˜åŠ¨`, currentDiffRate, currentAbsRate, change);
            }
        }

        // æ£€æŸ¥ Binance æœŸè´§ä»·æ ¼æ³¢åŠ¨
        function checkPriceChange(symbol, currentPrice) {
            const data = symbolData[symbol];
            
            if (!data) return;
            
            // åˆå§‹åŒ–ï¼šç¬¬ä¸€æ¬¡è·å–æ•°æ®æ—¶è®¾ç½®åˆå§‹ä»·æ ¼
            if (data.initialPrice === null) {
                data.initialPrice = currentPrice;
                data.baselinePrice = currentPrice;
                return;
            }
            
            // è®¡ç®—ä»·æ ¼å˜åŠ¨ç™¾åˆ†æ¯”
            const priceChange = currentPrice - data.baselinePrice;
            const priceChangePercent = (priceChange / data.baselinePrice) * 100;
            const priceChangeAbs = Math.abs(priceChangePercent);
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ä»·æ ¼æ³¢åŠ¨é˜ˆå€¼
            if (priceChangeAbs >= priceChangeThreshold) {
                data.priceAlertCount++;
                totalAlertCount++;
                document.getElementById('alertCount').textContent = totalAlertCount;
                
                // æ›´æ–°åŸºå‡†ä»·æ ¼ä¸ºå½“å‰ä»·æ ¼
                data.baselinePrice = currentPrice;
                
                // æ˜¾ç¤ºé€šçŸ¥
                const message = `ä»·æ ¼æ³¢åŠ¨è¾¾åˆ° ${priceChangeAbs.toFixed(2)}%\nå½“å‰ä»·æ ¼: $${currentPrice.toFixed(4)}\næ–°åŸºå‡†: $${currentPrice.toFixed(4)}`;
                showNotification(symbol, 'ğŸ’° Binanceä»·æ ¼å¤§å¹…æ³¢åŠ¨ï¼', message);
                
                // æ·»åŠ åˆ°å†å²è®°å½•
                addAlertToHistory(symbol, `ä»·æ ¼æ³¨åŠ¨`, priceChangePercent, currentPrice, priceChange);
            }
        }

        function createPriceCard(data) {
            const diffRate = data.futuresDifferenceRate;
            const diffClass = diffRate >= 0 ? 'positive' : 'negative';
            const diffSign = diffRate >= 0 ? '+' : '';
            
            // æ£€æŸ¥å·®ä»·ç‡å˜åŠ¨
            checkDifferenceRateChange(data.symbol, diffRate);
            
            // æ£€æŸ¥ Binance æœŸè´§ä»·æ ¼æ³¢åŠ¨
            checkPriceChange(data.symbol, data.binance.price);
            
            const symbolInfo = symbolData[data.symbol];
            const initialRate = symbolInfo?.initialRate ?? 0;
            const baselineRate = symbolInfo?.baselineRate ?? 0;
            const alertCount = symbolInfo?.alertCount ?? 0;
            const priceAlertCount = symbolInfo?.priceAlertCount ?? 0;
            const change = Math.abs(diffRate) - baselineRate;
            
            // ä»·æ ¼æ³¢åŠ¨ä¿¡æ¯
            const initialPrice = symbolInfo?.initialPrice ?? 0;
            const baselinePrice = symbolInfo?.baselinePrice ?? 0;
            const currentPrice = data.binance.price;
            const priceChangePercent = baselinePrice > 0 ? ((currentPrice - baselinePrice) / baselinePrice * 100) : 0;
            
            // Binance ç°è´§ vs æœŸè´§
            let spotFuturesHtml = '';
            if (data.binanceSpot && data.spotFuturesDifferenceRate !== null) {
                const spotDiffClass = data.spotFuturesDifferenceRate >= 0 ? 'positive' : 'negative';
                const spotDiffSign = data.spotFuturesDifferenceRate >= 0 ? '+' : '';
                spotFuturesHtml = `
                    <div class="spot-futures-section">
                        <div class="difference-label">ğŸ”„ Binance ç°è´§ vs æœŸè´§å·®ä»·ç‡</div>
                        <div class="spot-futures-grid">
                            <div class="spot-futures-item">
                                <div class="spot-futures-label">ğŸ’µ ç°è´§ä»·æ ¼</div>
                                <div class="spot-futures-value">
                                    $${formatPrice(data.binanceSpot.price)}
                                </div>
                            </div>
                            <div class="spot-futures-item">
                                <div class="spot-futures-label">ğŸ“ˆ æœŸè´§ä»·æ ¼</div>
                                <div class="spot-futures-value">
                                    $${formatPrice(data.binance.price)}
                                </div>
                            </div>
                            <div class="spot-futures-item">
                                <div class="spot-futures-label">å·®ä»·ç‡</div>
                                <div class="spot-futures-value ${spotDiffClass}">
                                    ${spotDiffSign}${data.spotFuturesDifferenceRate.toFixed(4)}%
                                </div>
                            </div>
                            <div class="spot-futures-item">
                                <div class="spot-futures-label">å¸‚åœºçŠ¶æ€</div>
                                <div class="spot-futures-value" style="font-size: 1em;">
                                    ${data.spotFuturesDifferenceRate > 0.1 ? 'æœŸè´§æº¶ä»·' : data.spotFuturesDifferenceRate < -0.1 ? 'æœŸè´§è´´æ°´' : 'åŸºæœ¬æŒå¹³'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="price-card">
                    <div class="symbol-title">${data.symbol} <span style="font-size: 0.6em; color: #e74c3c;">(å·®ä»·${alertCount}æ¬¡ | ä»·æ ¼${priceAlertCount}æ¬¡)</span></div>
                    
                    ${spotFuturesHtml}
                    
                    <div class="funding-section">
                        <div class="difference-label">  èµ„é‡‘è´¹ç‡å¯¹æ¯” (8å°æ—¶)</div>
                        <div class="funding-grid">
                            <div class="funding-item">
                                <div class="funding-label">ğŸŸ¡ Bybit</div>
                                <div class="funding-value ${data.bybitFunding8h >= 0 ? 'positive' : 'negative'}">
                                    ${data.bybitFunding8h >= 0 ? '+' : ''}${data.bybitFunding8h.toFixed(4)}%
                                </div>
                                <div class="funding-diff">ç»“ç®—é—´éš”: ${data.bybitInterval}å°æ—¶</div>
                            </div>
                            <div class="funding-item">
                                <div class="funding-label">ğŸŸ  Binance</div>
                                <div class="funding-value ${data.binanceFunding8h >= 0 ? 'positive' : 'negative'}">
                                    ${data.binanceFunding8h >= 0 ? '+' : ''}${data.binanceFunding8h.toFixed(4)}%
                                </div>
                                <div class="funding-diff">ç»“ç®—é—´éš”: ${data.binanceInterval}å°æ—¶</div>
                            </div>
                            <div class="funding-item">
                                <div class="funding-label">ğŸ“ˆ è´¹ç‡å·®å¼‚</div>
                                <div class="funding-value ${data.fundingDifference >= 0 ? 'positive' : 'negative'}">
                                    ${data.fundingDifference >= 0 ? '+' : ''}${data.fundingDifference.toFixed(4)}%
                                </div>
                                <div class="funding-diff">8å°æ—¶å·®å€¼</div>
                            </div>
                            <div class="funding-item">
                                <div class="funding-label">ğŸ’° å¥—åˆ©ç©ºé—´</div>
                                <div class="funding-value">
                                    ${Math.abs(data.fundingDifference).toFixed(4)}%
                                </div>
                                <div class="funding-diff">${Math.abs(data.fundingDifference) > 0.01 ? 'æœ‰å¥—åˆ©æœºä¼š' : 'å¥—åˆ©ç©ºé—´å°'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="difference-section">
                        <div class="difference-label">ğŸ¯ Bybit vs Binance æœŸè´§å·®ä»·ç‡</div>
                        <div class="difference-value ${diffClass}">
                            ${diffSign}${diffRate.toFixed(4)}%
                        </div>
                        <div class="price-time">
                            å·®ä»·: $${formatPrice(data.futuresPriceDifference)} | 
                            åˆå§‹: ${initialRate.toFixed(4)}% | 
                            åŸºå‡†: ${baselineRate.toFixed(4)}% | 
                            å˜åŠ¨: ${change >= 0 ? '+' : ''}${change.toFixed(4)}%
                        </div>
                    </div>
                    
                    <div class="difference-section" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
                        <div class="difference-label">ğŸ’° Binance æœŸè´§ä»·æ ¼æ³¢åŠ¨ç›‘æ§</div>
                        <div class="price-time" style="margin-top: 5px;">
                            åˆå§‹ä»·æ ¼: $${formatPrice(initialPrice)} | 
                            åŸºå‡†ä»·æ ¼: $${formatPrice(baselinePrice)} | 
                            å½“å‰ä»·æ ¼: $${formatPrice(currentPrice)} | 
                            æ³¢åŠ¨: ${priceChangePercent >= 0 ? '+' : ''}${priceChangePercent.toFixed(2)}%
                        </div>
                    </div>
                    
                    <div class="price-grid">
                        <div class="price-item bybit">
                            <div class="exchange-name">  Bybit æœŸè´§</div>
                            <div class="price-value">$${formatPrice(data.bybit.price)}</div>
                            <div class="price-time">${formatTime(data.bybit.timestamp)}</div>
                        </div>
                        
                        <div class="price-item binance">
                            <div class="exchange-name">  Binance æœŸè´§</div>
                            <div class="price-value">$${formatPrice(data.binance.price)}</div>
                            <div class="price-time">${formatTime(data.binance.timestamp)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function updateAllPrices() {
            if (monitoringSymbols.length === 0) {
                document.getElementById('priceContainer').innerHTML = '';
                return;
            }
            
            const container = document.getElementById('priceContainer');
            let html = '';
            let hasError = false;
            
            for (const symbol of monitoringSymbols) {
                try {
                    const data = await fetchPrices(symbol);
                    html += createPriceCard(data);
                } catch (error) {
                    html += `<div class="error">âŒ ${symbol}: ${error.message}</div>`;
                    hasError = true;
                }
            }
            
            container.innerHTML = html;
            
            if (!hasError) {
                document.getElementById('status').innerHTML = `âœ… ç›‘æ§ ${monitoringSymbols.length} ä¸ªå¸ç§... ä¸‹æ¬¡æ›´æ–°: 3ç§’å (é˜ˆå€¼: ${currentThreshold}%)`;
            }
        }

        function startMonitoring() {
            const thresholdInput = document.getElementById('thresholdInput').value;
            const priceChangeThresholdInput = document.getElementById('priceChangeThresholdInput').value;
            
            if (monitoringSymbols.length === 0) {
                alert('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªäº¤æ˜“å¯¹');
                return;
            }
            
            const threshold = parseFloat(thresholdInput);
            if (isNaN(threshold) || threshold <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å·®ä»·ç‡é˜ˆå€¼ï¼ˆå¤§äº0çš„æ•°å­—ï¼‰');
                return;
            }
            currentThreshold = threshold;
            
            const priceThreshold = parseFloat(priceChangeThresholdInput);
            if (isNaN(priceThreshold) || priceThreshold <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼æ³¢åŠ¨é˜ˆå€¼ï¼ˆå¤§äº0çš„æ•°å­—ï¼‰');
                return;
            }
            priceChangeThreshold = priceThreshold;
            
            stopMonitoring();
            
            for (const symbol of monitoringSymbols) {
                symbolData[symbol] = {
                    initialRate: null,
                    baselineRate: null,
                    alertCount: 0,
                    initialPrice: null,
                    baselinePrice: null,
                    priceAlertCount: 0
                };
            }
            
            totalAlertCount = 0;
            document.getElementById('alertCount').textContent = '0';
            document.getElementById('alertHistory').innerHTML = '';
            document.getElementById('alertSection').style.display = 'none';
            
            document.getElementById('status').innerHTML = `<span class="loading"></span> æ­£åœ¨è·å–ä»·æ ¼æ•°æ®... (å·®ä»·ç‡: ${currentThreshold}% | ä»·æ ¼æ³¢åŠ¨: ${priceChangeThreshold}%)`;
            
            updateAllPrices();
            intervalId = setInterval(updateAllPrices, 3000);
        }

        function stopMonitoring() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
                document.getElementById('status').innerHTML = `â¸ï¸ ç›‘æ§å·²åœæ­¢`;
            }
        }

        document.getElementById('symbolInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addSymbol();
            }
        });
    </script>
</body>
</html>
